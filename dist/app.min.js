'use strict';

(function (angular) {
  angular.module('Floaters', ['firebase', 'ui.router', 'ui.bootstrap', 'monospaced.qrcode']);
})(angular);
'use strict';

(function (angular, firebase) {
  var firebaseConn = firebase.initializeApp({
    apiKey: 'AIzaSyAxVfoAzfvSXqNb4IYvVHdRBA1v2HmiJZI',
    authDomain: 'firestarter-c211c.firebaseapp.com',
    databaseURL: 'https://firestarter-c211c.firebaseio.com',
    storageBucket: 'firestarter-c211c.appspot.com',
    messagingSenderId: '37797816176'
  });

  angular.module('Floaters').constant('db', firebaseConn.database()).constant('auth', firebase.auth()).constant('authProvider', new firebase.auth.GoogleAuthProvider()).run(['$rootScope', function ($rootScope) {
    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        $rootScope.user = user; // eslint-disable-line no-param-reassign
        $rootScope.$digest();
      }
    });
  }]);
})(angular, firebase);
'use strict';

(function (angular) {
  angular.module('Floaters').config(['$stateProvider', '$urlRouterProvider', function ($stateProvider, $urlRouterProvider) {
    $stateProvider.state('parade', {
      url: '/',
      component: 'parade'
    }).state('whatever', {
      url: '/whatever',
      component: 'whatever'
    }).state('floats', {
      url: '/floats',
      component: 'floats'
    });

    $urlRouterProvider.otherwise('/');
  }]);
})(angular);
'use strict';

(function (angular) {
  function getUserRef(db, $rootScope, $q) {
    return $q(function (resolve) {
      $rootScope.getUser.then(function (user) {
        resolve(db.ref(user.uid));
      });
    });
  }

  angular.module('Floaters').service('firebaseService', ['db', '$rootScope', '$q', function (db, $rootScope, $q) {
    this.getUserRef = function () {
      return getUserRef(db, $rootScope, $q);
    };
    this.rootRef = db.ref();
    this.floats = db.ref('floats');
    //      this.accounts = db.ref('accounts');
    //      this.requests = db.ref('collaborationRequests');
  }]);
})(angular);
'use strict';

(function (angular) {
    angular.module('Floaters').service('geoLocationService', ['$q', '$window', function ($q, $window) {
        this.getCurrentPosition = function () {
            var deferred = $q.defer();

            if (!$window.navigator.geolocation) {
                deferred.reject('Geolocation not supported.');
            } else {
                $window.navigator.geolocation.getCurrentPosition(function (position) {
                    deferred.resolve(position);
                }, function (err) {
                    deferred.reject(err);
                });
            }

            return deferred.promise;
        };

        this.getDistanceBetween = function (crd1, crd2) {
            console.log(crd1, crd2);
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(crd2.lat - crd1.lat); // deg2rad below
            var dLon = deg2rad(crd2.long - crd1.long);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(crd1.lat)) * Math.cos(deg2rad(crd2.lat)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d;
        };

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
    }]);
})(angular);
'use strict';

(function () {
  function FloatsController(firebaseService, $firebaseArray, $uibModal, $log, $document) {
    var $ctrl = this;

    $ctrl.newFloat = {
      name: 'BOgus NaME',
      description: '',
      imageUrl: '',
      position: null
    };

    $ctrl.floats = $firebaseArray(firebaseService.floats);

    $ctrl.openEditFloat = function (_float) {
      var modalInstance = $uibModal.open({
        animation: true,
        component: 'modalComponent',
        resolve: {
          float: function float() {
            return _float;
          }
        }
      });

      modalInstance.result.then(function (newFloat) {
        $ctrl.saveFloat(newFloat);
      }, function () {
        $log.info('modal-component dismissed at: ' + new Date());
      });
    };

    $ctrl.saveFloat = function (float) {
      var save = float.$id ? $ctrl.floats.$save : $ctrl.floats.$add;

      float.position.lat = parseFloat(float.position.lat);
      float.position.long = parseFloat(float.position.long);

      save(float).then(function (newRef) {
        float.$id = newRef.key;
        // tagService.applySelectedTags(event, types.event);
        $ctrl.newFloat = {};
      });
    };
  }

  angular.module('Floaters').component('floats', {
    templateUrl: 'views/floats.html',
    controller: ['firebaseService', '$firebaseArray', '$uibModal', '$log', '$document', FloatsController]
  });

  angular.module('Floaters').component('modalComponent', {
    templateUrl: 'addFloat.html',
    bindings: {
      resolve: '<',
      close: '&',
      dismiss: '&'
    },
    controller: function controller() {
      var $ctrl = this;

      $ctrl.$onInit = function () {
        $ctrl.float = $ctrl.resolve.float;
      };

      $ctrl.ok = function () {
        $ctrl.close({
          $value: $ctrl.float
        });
      };

      $ctrl.cancel = function () {
        $ctrl.dismiss({
          $value: 'cancel'
        });
      };
    }
  });
})();
'use strict';

(function () {
  function MainNavController(auth, authProvider) {
    function login() {
      // firebase.config.js sets $rootScope.user async
      auth.signInWithPopup(authProvider);
    }

    this.login = login;

    this.logout = function () {
      auth.signOut();
    };
  }
  angular.module('Floaters').component('mainNav', {
    templateUrl: 'views/mainNav.html',
    controller: ['auth', 'authProvider', MainNavController],
    controllerAs: 'mainNavController'
  });
})();
'use strict';

(function () {
  function ParadeController(firebaseService, $firebaseArray, geoLocationService, $scope) {
    var $ctrl = this;

    $ctrl.floats = $firebaseArray(firebaseService.floats);

    $ctrl.findNearest = function () {
      console.log('finding nearest');
      var closest = geoLocationService.getDistanceBetween($ctrl.floats[0].position, $ctrl.coords);
      var closestIdx = 0;

      for (var i = 1; i < $ctrl.floats.length; i++) {
        var dist = geoLocationService.getDistanceBetween($ctrl.floats[i].position, $ctrl.coords);
        console.log(dist, closest, closestIdx);
        if (dist < closest) {
          closest = dist;
          closestIdx = i;
        }
      }

      $scope.active = closestIdx;
    };

    $scope.$watch('active', function (newIdx, oldIdx) {
      if (!angular.isDefined(newIdx) || !angular.isDefined($ctrl.coords)) {
        return;
      }

      $ctrl.distance = geoLocationService.getDistanceBetween($ctrl.floats[newIdx].position, $ctrl.coords);
    });

    geoLocationService.getCurrentPosition().then(function (data) {
      $ctrl.coords = {
        lat: data.coords.latitude,
        long: data.coords.longitude
      };

      $ctrl.distance = geoLocationService.getDistanceBetween($ctrl.floats[$scope.active].position, $ctrl.coords);
    });
  }
  angular.module('Floaters').component('parade', {
    templateUrl: 'views/parade.html',
    controller: ['firebaseService', '$firebaseArray', 'geoLocationService', '$scope', ParadeController]
  });
})();
'use strict';

(function () {
  function WhateverController(geoLocationService) {
    var self = this;
    geoLocationService.getCurrentPosition().then(function (data) {
      console.log(data);
      self.coords = {
        lat: data.coords.latitude,
        long: data.coords.longitude
      };

      var crd1 = {
        lat: 36.847663,
        long: -76.293295
      };

      var crd2 = {
        lat: 36.844100,
        long: -76.287566
      };

      self.distance = geoLocationService.getDistanceBetween(self.coords, crd2);
    });
  }
  angular.module('Floaters').component('whatever', {
    templateUrl: 'views/whatever.html',
    controller: ['geoLocationService', WhateverController]
  });
})();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJhcHAubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuKGZ1bmN0aW9uIChhbmd1bGFyKSB7XG4gIGFuZ3VsYXIubW9kdWxlKCdGbG9hdGVycycsIFsnZmlyZWJhc2UnLCAndWkucm91dGVyJywgJ3VpLmJvb3RzdHJhcCcsICdtb25vc3BhY2VkLnFyY29kZSddKTtcbn0pKGFuZ3VsYXIpO1xuJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24gKGFuZ3VsYXIsIGZpcmViYXNlKSB7XG4gIHZhciBmaXJlYmFzZUNvbm4gPSBmaXJlYmFzZS5pbml0aWFsaXplQXBwKHtcbiAgICBhcGlLZXk6ICdBSXphU3lBeFZmb0F6ZnZTWHFOYjRJWXZWSGRSQkExdjJIbWlKWkknLFxuICAgIGF1dGhEb21haW46ICdmaXJlc3RhcnRlci1jMjExYy5maXJlYmFzZWFwcC5jb20nLFxuICAgIGRhdGFiYXNlVVJMOiAnaHR0cHM6Ly9maXJlc3RhcnRlci1jMjExYy5maXJlYmFzZWlvLmNvbScsXG4gICAgc3RvcmFnZUJ1Y2tldDogJ2ZpcmVzdGFydGVyLWMyMTFjLmFwcHNwb3QuY29tJyxcbiAgICBtZXNzYWdpbmdTZW5kZXJJZDogJzM3Nzk3ODE2MTc2J1xuICB9KTtcblxuICBhbmd1bGFyLm1vZHVsZSgnRmxvYXRlcnMnKS5jb25zdGFudCgnZGInLCBmaXJlYmFzZUNvbm4uZGF0YWJhc2UoKSkuY29uc3RhbnQoJ2F1dGgnLCBmaXJlYmFzZS5hdXRoKCkpLmNvbnN0YW50KCdhdXRoUHJvdmlkZXInLCBuZXcgZmlyZWJhc2UuYXV0aC5Hb29nbGVBdXRoUHJvdmlkZXIoKSkucnVuKFsnJHJvb3RTY29wZScsIGZ1bmN0aW9uICgkcm9vdFNjb3BlKSB7XG4gICAgZmlyZWJhc2UuYXV0aCgpLm9uQXV0aFN0YXRlQ2hhbmdlZChmdW5jdGlvbiAodXNlcikge1xuICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgJHJvb3RTY29wZS51c2VyID0gdXNlcjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuICAgICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfV0pO1xufSkoYW5ndWxhciwgZmlyZWJhc2UpO1xuJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24gKGFuZ3VsYXIpIHtcbiAgYW5ndWxhci5tb2R1bGUoJ0Zsb2F0ZXJzJykuY29uZmlnKFsnJHN0YXRlUHJvdmlkZXInLCAnJHVybFJvdXRlclByb3ZpZGVyJywgZnVuY3Rpb24gKCRzdGF0ZVByb3ZpZGVyLCAkdXJsUm91dGVyUHJvdmlkZXIpIHtcbiAgICAkc3RhdGVQcm92aWRlci5zdGF0ZSgncGFyYWRlJywge1xuICAgICAgdXJsOiAnLycsXG4gICAgICBjb21wb25lbnQ6ICdwYXJhZGUnXG4gICAgfSkuc3RhdGUoJ3doYXRldmVyJywge1xuICAgICAgdXJsOiAnL3doYXRldmVyJyxcbiAgICAgIGNvbXBvbmVudDogJ3doYXRldmVyJ1xuICAgIH0pLnN0YXRlKCdmbG9hdHMnLCB7XG4gICAgICB1cmw6ICcvZmxvYXRzJyxcbiAgICAgIGNvbXBvbmVudDogJ2Zsb2F0cydcbiAgICB9KTtcblxuICAgICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJy8nKTtcbiAgfV0pO1xufSkoYW5ndWxhcik7XG4ndXNlIHN0cmljdCc7XG5cbihmdW5jdGlvbiAoYW5ndWxhcikge1xuICBmdW5jdGlvbiBnZXRVc2VyUmVmKGRiLCAkcm9vdFNjb3BlLCAkcSkge1xuICAgIHJldHVybiAkcShmdW5jdGlvbiAocmVzb2x2ZSkge1xuICAgICAgJHJvb3RTY29wZS5nZXRVc2VyLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHtcbiAgICAgICAgcmVzb2x2ZShkYi5yZWYodXNlci51aWQpKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYW5ndWxhci5tb2R1bGUoJ0Zsb2F0ZXJzJykuc2VydmljZSgnZmlyZWJhc2VTZXJ2aWNlJywgWydkYicsICckcm9vdFNjb3BlJywgJyRxJywgZnVuY3Rpb24gKGRiLCAkcm9vdFNjb3BlLCAkcSkge1xuICAgIHRoaXMuZ2V0VXNlclJlZiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBnZXRVc2VyUmVmKGRiLCAkcm9vdFNjb3BlLCAkcSk7XG4gICAgfTtcbiAgICB0aGlzLnJvb3RSZWYgPSBkYi5yZWYoKTtcbiAgICB0aGlzLmZsb2F0cyA9IGRiLnJlZignZmxvYXRzJyk7XG4gICAgLy8gICAgICB0aGlzLmFjY291bnRzID0gZGIucmVmKCdhY2NvdW50cycpO1xuICAgIC8vICAgICAgdGhpcy5yZXF1ZXN0cyA9IGRiLnJlZignY29sbGFib3JhdGlvblJlcXVlc3RzJyk7XG4gIH1dKTtcbn0pKGFuZ3VsYXIpO1xuJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24gKGFuZ3VsYXIpIHtcbiAgICBhbmd1bGFyLm1vZHVsZSgnRmxvYXRlcnMnKS5zZXJ2aWNlKCdnZW9Mb2NhdGlvblNlcnZpY2UnLCBbJyRxJywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoJHEsICR3aW5kb3cpIHtcbiAgICAgICAgdGhpcy5nZXRDdXJyZW50UG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuXG4gICAgICAgICAgICBpZiAoISR3aW5kb3cubmF2aWdhdG9yLmdlb2xvY2F0aW9uKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KCdHZW9sb2NhdGlvbiBub3Qgc3VwcG9ydGVkLicpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAkd2luZG93Lm5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocG9zaXRpb24pO1xuICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuZ2V0RGlzdGFuY2VCZXR3ZWVuID0gZnVuY3Rpb24gKGNyZDEsIGNyZDIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNyZDEsIGNyZDIpO1xuICAgICAgICAgICAgdmFyIFIgPSA2MzcxOyAvLyBSYWRpdXMgb2YgdGhlIGVhcnRoIGluIGttXG4gICAgICAgICAgICB2YXIgZExhdCA9IGRlZzJyYWQoY3JkMi5sYXQgLSBjcmQxLmxhdCk7IC8vIGRlZzJyYWQgYmVsb3dcbiAgICAgICAgICAgIHZhciBkTG9uID0gZGVnMnJhZChjcmQyLmxvbmcgLSBjcmQxLmxvbmcpO1xuICAgICAgICAgICAgdmFyIGEgPSBNYXRoLnNpbihkTGF0IC8gMikgKiBNYXRoLnNpbihkTGF0IC8gMikgKyBNYXRoLmNvcyhkZWcycmFkKGNyZDEubGF0KSkgKiBNYXRoLmNvcyhkZWcycmFkKGNyZDIubGF0KSkgKiBNYXRoLnNpbihkTG9uIC8gMikgKiBNYXRoLnNpbihkTG9uIC8gMik7XG4gICAgICAgICAgICB2YXIgYyA9IDIgKiBNYXRoLmF0YW4yKE1hdGguc3FydChhKSwgTWF0aC5zcXJ0KDEgLSBhKSk7XG4gICAgICAgICAgICB2YXIgZCA9IFIgKiBjOyAvLyBEaXN0YW5jZSBpbiBrbVxuICAgICAgICAgICAgcmV0dXJuIGQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgZnVuY3Rpb24gZGVnMnJhZChkZWcpIHtcbiAgICAgICAgICAgIHJldHVybiBkZWcgKiAoTWF0aC5QSSAvIDE4MCk7XG4gICAgICAgIH1cbiAgICB9XSk7XG59KShhbmd1bGFyKTtcbid1c2Ugc3RyaWN0JztcblxuKGZ1bmN0aW9uICgpIHtcbiAgZnVuY3Rpb24gRmxvYXRzQ29udHJvbGxlcihmaXJlYmFzZVNlcnZpY2UsICRmaXJlYmFzZUFycmF5LCAkdWliTW9kYWwsICRsb2csICRkb2N1bWVudCkge1xuICAgIHZhciAkY3RybCA9IHRoaXM7XG5cbiAgICAkY3RybC5uZXdGbG9hdCA9IHtcbiAgICAgIG5hbWU6ICdCT2d1cyBOYU1FJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICAgIGltYWdlVXJsOiAnJyxcbiAgICAgIHBvc2l0aW9uOiBudWxsXG4gICAgfTtcblxuICAgICRjdHJsLmZsb2F0cyA9ICRmaXJlYmFzZUFycmF5KGZpcmViYXNlU2VydmljZS5mbG9hdHMpO1xuXG4gICAgJGN0cmwub3BlbkVkaXRGbG9hdCA9IGZ1bmN0aW9uIChfZmxvYXQpIHtcbiAgICAgIHZhciBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oe1xuICAgICAgICBhbmltYXRpb246IHRydWUsXG4gICAgICAgIGNvbXBvbmVudDogJ21vZGFsQ29tcG9uZW50JyxcbiAgICAgICAgcmVzb2x2ZToge1xuICAgICAgICAgIGZsb2F0OiBmdW5jdGlvbiBmbG9hdCgpIHtcbiAgICAgICAgICAgIHJldHVybiBfZmxvYXQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgbW9kYWxJbnN0YW5jZS5yZXN1bHQudGhlbihmdW5jdGlvbiAobmV3RmxvYXQpIHtcbiAgICAgICAgJGN0cmwuc2F2ZUZsb2F0KG5ld0Zsb2F0KTtcbiAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJGxvZy5pbmZvKCdtb2RhbC1jb21wb25lbnQgZGlzbWlzc2VkIGF0OiAnICsgbmV3IERhdGUoKSk7XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgJGN0cmwuc2F2ZUZsb2F0ID0gZnVuY3Rpb24gKGZsb2F0KSB7XG4gICAgICB2YXIgc2F2ZSA9IGZsb2F0LiRpZCA/ICRjdHJsLmZsb2F0cy4kc2F2ZSA6ICRjdHJsLmZsb2F0cy4kYWRkO1xuXG4gICAgICBmbG9hdC5wb3NpdGlvbi5sYXQgPSBwYXJzZUZsb2F0KGZsb2F0LnBvc2l0aW9uLmxhdCk7XG4gICAgICBmbG9hdC5wb3NpdGlvbi5sb25nID0gcGFyc2VGbG9hdChmbG9hdC5wb3NpdGlvbi5sb25nKTtcblxuICAgICAgc2F2ZShmbG9hdCkudGhlbihmdW5jdGlvbiAobmV3UmVmKSB7XG4gICAgICAgIGZsb2F0LiRpZCA9IG5ld1JlZi5rZXk7XG4gICAgICAgIC8vIHRhZ1NlcnZpY2UuYXBwbHlTZWxlY3RlZFRhZ3MoZXZlbnQsIHR5cGVzLmV2ZW50KTtcbiAgICAgICAgJGN0cmwubmV3RmxvYXQgPSB7fTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cblxuICBhbmd1bGFyLm1vZHVsZSgnRmxvYXRlcnMnKS5jb21wb25lbnQoJ2Zsb2F0cycsIHtcbiAgICB0ZW1wbGF0ZVVybDogJ3ZpZXdzL2Zsb2F0cy5odG1sJyxcbiAgICBjb250cm9sbGVyOiBbJ2ZpcmViYXNlU2VydmljZScsICckZmlyZWJhc2VBcnJheScsICckdWliTW9kYWwnLCAnJGxvZycsICckZG9jdW1lbnQnLCBGbG9hdHNDb250cm9sbGVyXVxuICB9KTtcblxuICBhbmd1bGFyLm1vZHVsZSgnRmxvYXRlcnMnKS5jb21wb25lbnQoJ21vZGFsQ29tcG9uZW50Jywge1xuICAgIHRlbXBsYXRlVXJsOiAnYWRkRmxvYXQuaHRtbCcsXG4gICAgYmluZGluZ3M6IHtcbiAgICAgIHJlc29sdmU6ICc8JyxcbiAgICAgIGNsb3NlOiAnJicsXG4gICAgICBkaXNtaXNzOiAnJidcbiAgICB9LFxuICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uIGNvbnRyb2xsZXIoKSB7XG4gICAgICB2YXIgJGN0cmwgPSB0aGlzO1xuXG4gICAgICAkY3RybC4kb25Jbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAkY3RybC5mbG9hdCA9ICRjdHJsLnJlc29sdmUuZmxvYXQ7XG4gICAgICB9O1xuXG4gICAgICAkY3RybC5vayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJGN0cmwuY2xvc2Uoe1xuICAgICAgICAgICR2YWx1ZTogJGN0cmwuZmxvYXRcbiAgICAgICAgfSk7XG4gICAgICB9O1xuXG4gICAgICAkY3RybC5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICRjdHJsLmRpc21pc3Moe1xuICAgICAgICAgICR2YWx1ZTogJ2NhbmNlbCdcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgIH1cbiAgfSk7XG59KSgpO1xuJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24gKCkge1xuICBmdW5jdGlvbiBNYWluTmF2Q29udHJvbGxlcihhdXRoLCBhdXRoUHJvdmlkZXIpIHtcbiAgICBmdW5jdGlvbiBsb2dpbigpIHtcbiAgICAgIC8vIGZpcmViYXNlLmNvbmZpZy5qcyBzZXRzICRyb290U2NvcGUudXNlciBhc3luY1xuICAgICAgYXV0aC5zaWduSW5XaXRoUG9wdXAoYXV0aFByb3ZpZGVyKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2luID0gbG9naW47XG5cbiAgICB0aGlzLmxvZ291dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGF1dGguc2lnbk91dCgpO1xuICAgIH07XG4gIH1cbiAgYW5ndWxhci5tb2R1bGUoJ0Zsb2F0ZXJzJykuY29tcG9uZW50KCdtYWluTmF2Jywge1xuICAgIHRlbXBsYXRlVXJsOiAndmlld3MvbWFpbk5hdi5odG1sJyxcbiAgICBjb250cm9sbGVyOiBbJ2F1dGgnLCAnYXV0aFByb3ZpZGVyJywgTWFpbk5hdkNvbnRyb2xsZXJdLFxuICAgIGNvbnRyb2xsZXJBczogJ21haW5OYXZDb250cm9sbGVyJ1xuICB9KTtcbn0pKCk7XG4ndXNlIHN0cmljdCc7XG5cbihmdW5jdGlvbiAoKSB7XG4gIGZ1bmN0aW9uIFBhcmFkZUNvbnRyb2xsZXIoZmlyZWJhc2VTZXJ2aWNlLCAkZmlyZWJhc2VBcnJheSwgZ2VvTG9jYXRpb25TZXJ2aWNlLCAkc2NvcGUpIHtcbiAgICB2YXIgJGN0cmwgPSB0aGlzO1xuXG4gICAgJGN0cmwuZmxvYXRzID0gJGZpcmViYXNlQXJyYXkoZmlyZWJhc2VTZXJ2aWNlLmZsb2F0cyk7XG5cbiAgICAkY3RybC5maW5kTmVhcmVzdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdmaW5kaW5nIG5lYXJlc3QnKTtcbiAgICAgIHZhciBjbG9zZXN0ID0gZ2VvTG9jYXRpb25TZXJ2aWNlLmdldERpc3RhbmNlQmV0d2VlbigkY3RybC5mbG9hdHNbMF0ucG9zaXRpb24sICRjdHJsLmNvb3Jkcyk7XG4gICAgICB2YXIgY2xvc2VzdElkeCA9IDA7XG5cbiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgJGN0cmwuZmxvYXRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhciBkaXN0ID0gZ2VvTG9jYXRpb25TZXJ2aWNlLmdldERpc3RhbmNlQmV0d2VlbigkY3RybC5mbG9hdHNbaV0ucG9zaXRpb24sICRjdHJsLmNvb3Jkcyk7XG4gICAgICAgIGNvbnNvbGUubG9nKGRpc3QsIGNsb3Nlc3QsIGNsb3Nlc3RJZHgpO1xuICAgICAgICBpZiAoZGlzdCA8IGNsb3Nlc3QpIHtcbiAgICAgICAgICBjbG9zZXN0ID0gZGlzdDtcbiAgICAgICAgICBjbG9zZXN0SWR4ID0gaTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAkc2NvcGUuYWN0aXZlID0gY2xvc2VzdElkeDtcbiAgICB9O1xuXG4gICAgJHNjb3BlLiR3YXRjaCgnYWN0aXZlJywgZnVuY3Rpb24gKG5ld0lkeCwgb2xkSWR4KSB7XG4gICAgICBpZiAoIWFuZ3VsYXIuaXNEZWZpbmVkKG5ld0lkeCkgfHwgIWFuZ3VsYXIuaXNEZWZpbmVkKCRjdHJsLmNvb3JkcykpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAkY3RybC5kaXN0YW5jZSA9IGdlb0xvY2F0aW9uU2VydmljZS5nZXREaXN0YW5jZUJldHdlZW4oJGN0cmwuZmxvYXRzW25ld0lkeF0ucG9zaXRpb24sICRjdHJsLmNvb3Jkcyk7XG4gICAgfSk7XG5cbiAgICBnZW9Mb2NhdGlvblNlcnZpY2UuZ2V0Q3VycmVudFBvc2l0aW9uKCkudGhlbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgJGN0cmwuY29vcmRzID0ge1xuICAgICAgICBsYXQ6IGRhdGEuY29vcmRzLmxhdGl0dWRlLFxuICAgICAgICBsb25nOiBkYXRhLmNvb3Jkcy5sb25naXR1ZGVcbiAgICAgIH07XG5cbiAgICAgICRjdHJsLmRpc3RhbmNlID0gZ2VvTG9jYXRpb25TZXJ2aWNlLmdldERpc3RhbmNlQmV0d2VlbigkY3RybC5mbG9hdHNbJHNjb3BlLmFjdGl2ZV0ucG9zaXRpb24sICRjdHJsLmNvb3Jkcyk7XG4gICAgfSk7XG4gIH1cbiAgYW5ndWxhci5tb2R1bGUoJ0Zsb2F0ZXJzJykuY29tcG9uZW50KCdwYXJhZGUnLCB7XG4gICAgdGVtcGxhdGVVcmw6ICd2aWV3cy9wYXJhZGUuaHRtbCcsXG4gICAgY29udHJvbGxlcjogWydmaXJlYmFzZVNlcnZpY2UnLCAnJGZpcmViYXNlQXJyYXknLCAnZ2VvTG9jYXRpb25TZXJ2aWNlJywgJyRzY29wZScsIFBhcmFkZUNvbnRyb2xsZXJdXG4gIH0pO1xufSkoKTtcbid1c2Ugc3RyaWN0JztcblxuKGZ1bmN0aW9uICgpIHtcbiAgZnVuY3Rpb24gV2hhdGV2ZXJDb250cm9sbGVyKGdlb0xvY2F0aW9uU2VydmljZSkge1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBnZW9Mb2NhdGlvblNlcnZpY2UuZ2V0Q3VycmVudFBvc2l0aW9uKCkudGhlbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICBzZWxmLmNvb3JkcyA9IHtcbiAgICAgICAgbGF0OiBkYXRhLmNvb3Jkcy5sYXRpdHVkZSxcbiAgICAgICAgbG9uZzogZGF0YS5jb29yZHMubG9uZ2l0dWRlXG4gICAgICB9O1xuXG4gICAgICB2YXIgY3JkMSA9IHtcbiAgICAgICAgbGF0OiAzNi44NDc2NjMsXG4gICAgICAgIGxvbmc6IC03Ni4yOTMyOTVcbiAgICAgIH07XG5cbiAgICAgIHZhciBjcmQyID0ge1xuICAgICAgICBsYXQ6IDM2Ljg0NDEwMCxcbiAgICAgICAgbG9uZzogLTc2LjI4NzU2NlxuICAgICAgfTtcblxuICAgICAgc2VsZi5kaXN0YW5jZSA9IGdlb0xvY2F0aW9uU2VydmljZS5nZXREaXN0YW5jZUJldHdlZW4oc2VsZi5jb29yZHMsIGNyZDIpO1xuICAgIH0pO1xuICB9XG4gIGFuZ3VsYXIubW9kdWxlKCdGbG9hdGVycycpLmNvbXBvbmVudCgnd2hhdGV2ZXInLCB7XG4gICAgdGVtcGxhdGVVcmw6ICd2aWV3cy93aGF0ZXZlci5odG1sJyxcbiAgICBjb250cm9sbGVyOiBbJ2dlb0xvY2F0aW9uU2VydmljZScsIFdoYXRldmVyQ29udHJvbGxlcl1cbiAgfSk7XG59KSgpOyJdLCJmaWxlIjoiYXBwLm1pbi5qcyJ9
